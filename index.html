<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIP助手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@radix-ui/themes@2.0.3/styles.css" rel="stylesheet" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .container {
            display: flex;
            height: calc(100vh - 60px);
            overflow: hidden;
        }

        .column {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 2rem;
            overflow-y: auto;
        }

        .right-column {
            flex: 1.5;
        }

        .editable-content {
            min-height: 300px;
            max-height: 600px;
            overflow-y: auto;
        }

        .custom-select-wrapper {
            position: relative;
            user-select: none;
            width: 100%;
            max-width: 300px;
        }

        .custom-select {
            position: relative;
            display: flex;
            flex-direction: column;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .custom-select__trigger {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 22px;
            font-size: 16px;
            font-weight: 500;
            color: #333;
            height: 50px;
            line-height: 50px;
            background: #ffffff;
            cursor: pointer;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        .custom-options {
            position: absolute;
            display: block;
            top: 100%;
            left: 0;
            right: 0;
            border: 1px solid #e0e0e0;
            border-top: 0;
            background: #fff;
            transition: all 0.3s;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            z-index: 2;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .custom-select.open .custom-options {
            opacity: 1;
            visibility: visible;
            pointer-events: all;
        }

        .custom-option {
            position: relative;
            display: block;
            padding: 12px 22px;
            font-size: 16px;
            font-weight: 400;
            color: #333;
            line-height: 24px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .custom-option:hover {
            cursor: pointer;
            background-color: #f5f5f5;
        }

        .custom-option.selected {
            color: #ffffff;
            background-color: #3b82f6;
        }

        .arrow {
            position: relative;
            height: 15px;
            width: 15px;
        }

        .arrow::before,
        .arrow::after {
            content: "";
            position: absolute;
            bottom: 0px;
            width: 0.15rem;
            height: 100%;
            transition: all 0.3s;
        }

        .arrow::before {
            left: -5px;
            transform: rotate(45deg);
            background-color: #394a6d;
        }

        .arrow::after {
            left: 5px;
            transform: rotate(-45deg);
            background-color: #394a6d;
        }

        .open .arrow::before {
            left: -5px;
            transform: rotate(-45deg);
        }

        .open .arrow::after {
            left: 5px;
            transform: rotate(45deg);
        }

        .hotspot-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>

<body class="bg-zinc-100 text-zinc-900">
    <header class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex items-center">
            <svg class="h-8 w-8 mr-2" width="43" height="26" viewBox="0 0 43 26" fill="none"
                xmlns="http://www.w3.org/2000/svg">
                <!-- Your SVG code here -->
            </svg>
            <h1 class="text-3xl font-bold text-zinc-900">AIP助手</h1>
        </div>
    </header>

    <div class="container max-w-7xl mx-auto">
        <div class="column bg-white m-4 rounded-lg shadow-lg">
            <h2 class="text-2xl font-semibold mb-4">当前热点</h2>
            <div class="hotspot-controls">
                <div class="custom-select-wrapper">
                    <div class="custom-select">
                        <div class="custom-select__trigger"><span>正在获取热点</span>
                            <div class="arrow"></div>
                        </div>
                        <div class="custom-options">
                            <!-- Options will be dynamically added here -->
                        </div>
                    </div>
                </div>
                <button id="hotSearchBtn"
                    class="px-4 py-2 bg-zinc-800 text-white rounded-md hover:bg-zinc-700 transition-colors duration-200"
                    onclick="sendRequest('hotSearch')">刷新热点</button>
            </div>
            <div id="hotSearchLoader" class="loader hidden"></div>
            <div id="hotSearchResponseArea" class="hidden">
                <ul id="hotSearchContent" class="space-y-2"></ul>
            </div>
        </div>

        <div class="column right-column bg-white m-4 rounded-lg shadow-lg">
            <h2 class="text-2xl font-semibold mb-4">文案内容</h2>
            <div id="rewriteLoader" class="loader hidden"></div>
            <div id="rewriteResponseArea" class="hidden">
                <p id="generatingMessage" class="text-center text-lg text-zinc-600 mt-8 hidden">正在生成文案中，大约一分钟...</p>
                <div id="contentArea"></div>
            </div>
        </div>
    </div>

    <script>

        let hotSearchData = [];
        let currentRewrittenContent = '';
        let currentOrigin = '';
        let currentTopic = '';

        function sendRequest(type, input = '') {
            const submitBtn = type === 'rewrite' ? document.getElementById('submitBtn') : document.getElementById('hotSearchBtn');
            const loader = document.getElementById(type + 'Loader');
            const responseArea = document.getElementById(type + 'ResponseArea');

            if (type === 'hotSearch') {
                input = '热搜';
                document.querySelector('.custom-select__trigger span').textContent = '正在获取热点';
            }

            if (submitBtn) submitBtn.disabled = true;
            if (loader) loader.classList.remove('hidden');
            if (responseArea) responseArea.classList.remove('hidden');

            if (type === 'rewrite') {
                document.getElementById('generatingMessage').classList.remove('hidden');
                document.getElementById('contentArea').innerHTML = '';
            }

            const myHeaders = new Headers({
                "Authorization": "Bearer pat_4v9gSIB3HXfqxMeXmXGG4gWHEVfiUrZfArcKIK06dXTFlVEiyQPuQMhDNzh2BUfe",
                "User-Agent": "Apifox/1.0.0 (https://apifox.com)",
                "Content-Type": "application/json",
                "Accept": "*/*",
                "Host": "api.coze.cn",
                "Connection": "keep-alive"
            });

            let query = input;
            if (type === 'rewrite') {
                query = JSON.stringify({
                    origin: currentOrigin,
                    user: "",
                    goal: "",
                    topic: currentTopic
                });
            }

            let rawData = {
                "conversation_id": "123",
                "bot_id": type === 'rewrite' ? "7399186570660200448" : (type === 'douyin' ? "7399539580141387810" : "7395453761768063002"),
                "user": "29032201862555",
                "query": query,
                "stream": false
            };

            const raw = JSON.stringify(rawData);

            return fetch("https://api.coze.cn/open_api/v2/chat", {
                method: 'POST',
                headers: myHeaders,
                body: raw
            })
                .then(response => response.json())
                .then(result => {
                    parseJSON(result, type);
                    if (submitBtn) submitBtn.disabled = false;
                    if (loader) loader.classList.add('hidden');
                    return result;
                })
                .catch(error => {
                    console.error('Error:', error);
                    showErrorMessage('请求失败，请稍后再试。');
                    if (submitBtn) submitBtn.disabled = false;
                    if (loader) loader.classList.add('hidden');
                    throw error;
                });
        }

        function parseJSON(jsonResponse, type) {
            if (jsonResponse.messages && jsonResponse.messages.length > 0) {
                const assistantMessage = jsonResponse.messages.find(msg => msg.role === 'assistant' && msg.type === 'answer');
                if (assistantMessage) {
                    if (type === 'rewrite') {
                        displayRewriteContent(assistantMessage.content);
                    } else if (type === 'douyin') {
                        processDouyinContent(assistantMessage.content);
                    } else if (type === 'hotSearch') {
                        hotSearchData = JSON.parse(assistantMessage.content).output;
                        createHotSearchOptions();
                    }
                } else {
                    showErrorMessage('未找到有效的响应内容。');
                }
            } else {
                showErrorMessage('响应格式不正确。');
            }
        }

        function createHotSearchOptions() {
            const optionsContainer = document.querySelector('.custom-options');
            optionsContainer.innerHTML = '';

            let douyinIndex = 0;
            hotSearchData.forEach((data, index) => {
                const option = document.createElement('span');
                option.className = 'custom-option';
                option.setAttribute('data-value', index);
                option.textContent = data.name;
                optionsContainer.appendChild(option);

                if (data.name === '抖音') {
                    douyinIndex = index;
                }
            });

            const triggerSpan = document.querySelector('.custom-select__trigger span');
            triggerSpan.textContent = hotSearchData[douyinIndex].name;
            currentTopic = hotSearchData[douyinIndex].name;
            showHotSearchContent(douyinIndex);
        }

        function showHotSearchContent(index) {
            const hotSearchList = document.getElementById('hotSearchContent');
            if (!hotSearchList) return;

            hotSearchList.innerHTML = '';
            if (index === '' || !hotSearchData[index]) {
                return;
            }
            currentTopic = hotSearchData[index].name;
            hotSearchData[index].data.forEach(item => {
                const li = document.createElement('li');
                li.className = 'p-3 bg-zinc-50 rounded-lg shadow hover:shadow-md transition-shadow duration-200';
                li.innerHTML = `
            <a href="#" class="flex items-center justify-between" onclick="getDouyinContent('${item.title}'); return false;">
                <span class="font-medium">${item.title}</span>
                <span class="text-sm text-zinc-500">${item.hot} 🔥</span>
            </a>
        `;
                hotSearchList.appendChild(li);
            });
        }

        function getDouyinContent(keyword) {
            const rewriteResponseArea = document.getElementById('rewriteResponseArea');
            const generatingMessage = document.getElementById('generatingMessage');
            if (rewriteResponseArea && generatingMessage) {
                rewriteResponseArea.classList.remove('hidden');
                generatingMessage.classList.remove('hidden');
                document.getElementById('contentArea').innerHTML = '';
            }

            sendRequest('douyin', keyword)
                .then(result => {
                    if (result && result.messages) {
                        const assistantMessage = result.messages.find(msg => msg.role === 'assistant' && msg.type === 'answer');
                        if (assistantMessage) {
                            processDouyinContent(assistantMessage.content);
                        } else {
                            showErrorMessage('未收到预期的响应格式。');
                        }
                    } else {
                        showErrorMessage('获取内容失败。请稍后重试。');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showErrorMessage('获取内容时发生错误。请稍后重试。');
                });
        }

        function processDouyinContent(content) {
            try {
                const parsedContent = JSON.parse(content);
                if (parsedContent && parsedContent.output) {
                    currentOrigin = parsedContent.output;
                    // 获取到抖音内容后，立即请求生成文案
                    sendRequest('rewrite', currentOrigin);
                } else {
                    showErrorMessage('未找到有效的抖音内容。');
                }
            } catch (error) {
                console.error('Error parsing Douyin content:', error);
                showErrorMessage('处理抖音内容时出错。');
            }
        }

        function displayRewriteContent(content) {
            document.getElementById('generatingMessage').classList.add('hidden');
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
        <div class="bg-zinc-50 p-6 rounded-lg shadow-lg">
            <h3 class="text-xl font-semibold mb-4">生成的文案</h3>
            <div id="editableContent" class="editable-content bg-white border border-zinc-300 p-4 rounded-md mb-4" contenteditable="true">${content}</div>
            <button id="copyButton" class="w-full p-2 bg-zinc-800 text-white rounded-md hover:bg-zinc-700 transition-colors duration-200">复制文案</button>
        </div>
    `;
            currentRewrittenContent = content;

            // 为复制按钮添加事件监听器
            document.getElementById('copyButton').addEventListener('click', copyContent);
        }

        function copyContent() {
            const contentElement = document.getElementById('editableContent');
            if (!contentElement) return;

            const content = contentElement.innerText;
            navigator.clipboard.writeText(content).then(() => {
                alert('文案已复制到剪贴板');
            }).catch(err => {
                console.error('复制失败:', err);
                alert('复制失败，请手动复制');
            });
        }

        function showErrorMessage(message) {
            const rewriteResponseArea = document.getElementById('rewriteResponseArea');
            if (rewriteResponseArea) {
                rewriteResponseArea.innerHTML = `<p class="text-center text-red-600 mt-4">${message}</p>`;
            }
            document.getElementById('generatingMessage').classList.add('hidden');
        }

        function initCustomSelect() {
            const select = document.querySelector('.custom-select');
            const selectTrigger = select.querySelector('.custom-select__trigger');
            const options = select.querySelector('.custom-options');

            selectTrigger.addEventListener('click', () => {
                select.classList.toggle('open');
            });

            options.addEventListener('click', (event) => {
                if (event.target.classList.contains('custom-option')) {
                    const value = event.target.getAttribute('data-value');
                    selectTrigger.querySelector('span').textContent = event.target.textContent;
                    select.classList.remove('open');
                    showHotSearchContent(value);
                }
            });

            document.addEventListener('click', (event) => {
                if (!select.contains(event.target)) {
                    select.classList.remove('open');
                }
            });
        }

        // Initialize the custom select when the window loads
        window.onload = function () {
            initCustomSelect();
            sendRequest('hotSearch');
            document.querySelector('.custom-select__trigger span').textContent = '正在获取热点';
        };
    </script>
</body>

</html>
